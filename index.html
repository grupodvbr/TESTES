<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Painel de Reservas â€¢ Mercatto DelÃ­cia</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <style>
    :root{
      --bg:#eef3f8; --card:#fff; --text:#1f2937; --muted:#6b7280; --line:#e5e7eb;
      --brand:#2563eb; --brand-2:#1e40af; --ok:#16a34a; --warn:#b45309; --danger:#ef4444;
      --accent:#b75507; --radius:14px;
    }
    body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text);margin:0;padding:20px}
    header{margin-bottom:20px}
    h1{font-size:1.5rem;margin:0}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px}
    .card{background:var(--card);padding:16px;border-radius:var(--radius);box-shadow:0 1px 3px rgba(0,0,0,0.1)}
    .muted{color:var(--muted);font-size:.9em}
    .btn{padding:8px 14px;border:none;border-radius:8px;cursor:pointer;background:var(--brand);color:#fff}
    .btn:hover{background:var(--brand-2)}
    .danger{background:var(--danger)}
    .ok{background:var(--ok)}
    .warn{background:var(--warn)}
    .reserva-anexos img{max-width:120px;max-height:120px;margin:4px;border-radius:8px;display:block}
  </style>
</head>
<body>
<header>
  <h1>Painel de Reservas</h1>
  <button id="newBtn" class="btn">+ Nova Reserva</button>
</header>

<section id="res-list" class="grid"></section>

<section id="summary" class="card">
  <h3>Resumo do mÃªs</h3>
  <p>Total adiantamentos: <b id="sAdiant">R$ 0,00</b></p>
  <p>Total pagos: <b id="sFinal">R$ 0,00</b></p>
  <p><b>Total do mÃªs:</b> <span id="sTotal">R$ 0,00</span></p>
</section>

<!-- Modal -->
<div id="popup" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:#0007;align-items:center;justify-content:center;">
  <div style="background:#fff;padding:20px;border-radius:10px;max-width:500px;width:100%;color:#000;">
    <h3 id="popupTitle">Reserva</h3>
    <label>Nome:<br><input id="pNome" required></label><br>
    <label>Email:<br><input id="pEmail"></label><br>
    <label>Telefone:<br><input id="pTel"></label><br>
    <label>Pessoas:<br><input id="pPessoas" type="number"></label><br>
    <label>Mesa:<br><input id="pMesa"></label><br>
    <label>Data/Hora:<br><input id="pData" type="datetime-local"></label><br>
    <label>Valor Estimado:<br><input id="pValor" type="text"></label><br>
    <label>Adiantamento:<br><input id="pAdiantamento" type="text"></label><br>
    <label>Extras:<br><input id="pExtras" type="text" placeholder="Separe por vÃ­rgula"></label><br>
    <label>ObservaÃ§Ãµes:<br><textarea id="pObs"></textarea></label><br>
    <label>Anexo:<br><input id="pFile" type="file"></label><br><br>
    <button id="saveBtn" class="btn">Salvar</button>
    <button id="cancelBtn" class="btn warn">Cancelar</button>
  </div>
</div>

<script>
const endpoint = "SUA_URL_DO_WEBAPP"; // substituir pelo seu deploy

const api = {
  async listar(ano,mes){
    const res = await fetch(`${endpoint}?acao=listar&ano=${ano}&mes=${mes}`);
    return res.json();
  },
  async cadastrar(payload){
    return fetch(endpoint,{method:"POST",headers:{'Content-Type':'application/json'},
      body:JSON.stringify({acao:"cadastrar",...payload})}).then(r=>r.text());
  },
  async atualizar(payload){
    return fetch(endpoint,{method:"POST",headers:{'Content-Type':'application/json'},
      body:JSON.stringify({acao:"atualizar",...payload})}).then(r=>r.text());
  },
  async excluir(id){
    return fetch(endpoint,{method:"POST",headers:{'Content-Type':'application/json'},
      body:JSON.stringify({acao:"excluir",id})}).then(r=>r.text());
  }
};

let reservas=[],editId=null;

function render(){
  const list=document.getElementById("res-list");
  list.innerHTML="";
  reservas.forEach(r=>{
    const card=document.createElement("div");
    card.className="card";
    const anexos=Object.keys(r).filter(k=>k.startsWith("Anexo")).map((k,i)=>{
      const url=r[k];
      if(url&&/\.(jpg|jpeg|png)$/i.test(url)){
        return `<a href="${url}" target="_blank"><img src="${url}"></a>`;
      }else if(url){
        return `<a href="${url}" target="_blank">ðŸ“Ž Anexo ${i+1}</a>`;
      }
      return "";
    }).join("");
    card.innerHTML=`
      <h4>${r.Nome}</h4>
      <p>${r.DataHora}</p>
      <p><b>Adiantamento:</b> ${r.pagamentoAntecipado||"0"}</p>
      <p><b>Pagamentos extras:</b> ${[r.PagamentoExtra1,r.PagamentoExtra2,r.PagamentoExtra3].filter(Boolean).join(", ")||"-"}</p>
      <div class="reserva-anexos">${anexos}</div>
      <button class="btn ok" onclick="openEdit('${r.ID}')">Editar</button>
      <button class="btn danger" onclick="delRes('${r.ID}')">Excluir</button>
    `;
    list.appendChild(card);
  });
  updateSummary();
}

function updateSummary(){
  let adi=0, fin=0;
  reservas.forEach(r=>{
    adi+=parseFloat(r.pagamentoAntecipado||0);
    ["PagamentoExtra1","PagamentoExtra2","PagamentoExtra3"].forEach(k=>{
      fin+=parseFloat(r[k]||0);
    });
    fin+=parseFloat(r.valorFinalPago||0);
  });
  document.getElementById("sAdiant").textContent="R$ "+adi.toFixed(2);
  document.getElementById("sFinal").textContent="R$ "+fin.toFixed(2);
  document.getElementById("sTotal").textContent="R$ "+(adi+fin).toFixed(2);
}

function openNew(){editId=null;document.getElementById("popup").style.display="flex";}
function openEdit(id){editId=id;document.getElementById("popup").style.display="flex";}
function closePopup(){document.getElementById("popup").style.display="none";}

async function save(){
  const payload={
    id:editId,
    nome:document.getElementById("pNome").value,
    email:document.getElementById("pEmail").value,
    telefone:document.getElementById("pTel").value,
    pessoas:document.getElementById("pPessoas").value,
    mesa:document.getElementById("pMesa").value,
    datahora:document.getElementById("pData").value,
    valorEstimado:document.getElementById("pValor").value,
    pagamentoAntecipado:document.getElementById("pAdiantamento").value,
    extras:document.getElementById("pExtras").value,
    observacoes:document.getElementById("pObs").value
  };
  const file=document.getElementById("pFile").files[0];
  if(file){
    payload.nomeArquivo=file.name;
    payload.arquivo=await toBase64(file);
  }
  let msg= editId? await api.atualizar(payload): await api.cadastrar(payload);
  alert(msg);closePopup();load();
}

function delRes(id){
  if(confirm("Excluir?")){api.excluir(id).then(m=>{alert(m);load();});}
}

function toBase64(file){
  return new Promise((res,rej)=>{
    const reader=new FileReader();
    reader.onload=()=>res(reader.result.split(",")[1]);
    reader.onerror=e=>rej(e);
    reader.readAsDataURL(file);
  });
}

async function load(){
  const now=new Date();
  reservas=await api.listar(now.getFullYear(),now.getMonth()+1);
  render();
}

document.getElementById("newBtn").onclick=openNew;
document.getElementById("cancelBtn").onclick=closePopup;
document.getElementById("saveBtn").onclick=save;

load();
</script>
</body>
</html>
