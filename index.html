<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Reservas de AniversÃ¡rios â€¢ Mercatto DelÃ­cia</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">

<!-- FullCalendar -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

<style>
  :root {
    /* Tema claro */
    --bg:#fafafa;--card:#ffffff;--ink:#1e293b;--muted:#64748b;
    --green:#16a34a;--red:#dc2626;--blue:#2563eb;--yellow:#facc15;
  }
  @media (prefers-color-scheme: dark) {
    :root {
      --bg:#0b0e13;--card:#12161d;--ink:#f5f7fb;--muted:#9aa0ad;
      --green:#16a34a;--red:#ef4444;--blue:#3b82f6;--yellow:#eab308;
    }
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:system-ui,Arial,sans-serif;
    background:var(--bg);
    color:var(--ink);
    transition:background .3s,color .3s;
  }
  header{
    text-align:center;
    padding:16px;
    font-size:22px;
    font-weight:700;
    background:var(--blue);
    color:#fff;
    box-shadow:0 2px 6px rgba(0,0,0,.2);
  }
  #calendar{
    max-width:1200px;
    margin:20px auto;
    padding:10px;
    background:var(--card);
    border-radius:12px;
    box-shadow:0 2px 6px rgba(0,0,0,.1);
  }
  .fc-toolbar-title{color:var(--ink)!important}
  .fc-button-primary{
    background:var(--blue)!important;
    border:none!important;
  }

  /* Modal */
  .modal{
    position:fixed;inset:0;
    background:rgba(0,0,0,.6);
    display:none;align-items:center;justify-content:center;
    backdrop-filter:blur(3px);
  }
  .modal.show{display:flex}
  .card{
    background:var(--card);
    color:var(--ink);
    padding:24px;
    border-radius:14px;
    max-width:460px;
    width:90%;
    box-shadow:0 6px 20px rgba(0,0,0,.25);
    animation:pop .25s ease;
  }
  @keyframes pop{from{transform:scale(.9);opacity:0}to{transform:scale(1);opacity:1}}
  .card h2{margin-top:0;text-align:center;font-size:20px}
  .row{margin:6px 0;font-size:15px}
  .btns{display:flex;justify-content:space-between;margin-top:20px;gap:8px}
  button{
    flex:1;
    padding:12px;
    border:none;
    border-radius:8px;
    font-weight:700;
    cursor:pointer;
    color:#fff;
    transition:filter .2s,transform .1s;
  }
  button:active{transform:scale(.97)}
  .accept{background:var(--green)}
  .finish{background:var(--blue)}
  .close{background:var(--red)}
  button:hover{filter:brightness(1.08)}
</style>
</head>
<body>
<header>ðŸŽ‰ Reservas de AniversÃ¡rios â€¢ Mercatto DelÃ­cia</header>
<div id="calendar"></div>

<!-- Modal -->
<div class="modal" id="modal">
  <div class="card">
    <h2>ðŸŽ‚ Detalhes da Reserva</h2>
    <div id="detalhes"></div>
    <div class="btns">
      <button class="accept" id="btnAceitar">Aceitar</button>
      <button class="finish" id="btnFinalizar">Finalizar</button>
      <button class="close" id="btnFechar">Fechar</button>
    </div>
  </div>
</div>

<script>
const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbxLXYQnMVCIRCJUv0KXof7FXGfE68o7nhEkDvOZ3hjlmzoPitmGLYz0yjn_lpF0RCObvQ/exec";

let reservas = [];
let reservaAtual = null;

// ðŸ§­ Carregar reservas do Google Sheets
async function carregarReservas(){
  try{
    const res = await fetch(GAS_ENDPOINT + "?acao=listar");
    reservas = await res.json();

    const eventos = reservas.map(r => ({
      title: r.Nome || "(sem nome)",
      start: r["Data/Hora"] || null,
      backgroundColor:
        r.Status?.toLowerCase() === "aceita" ? "#16a34a" :
        r.Status?.toLowerCase() === "finalizada" ? "#2563eb" : "#facc15",
      borderColor:"#000",
      textColor:"#000",
      extendedProps:r
    })).filter(ev => ev.start);

    const calendarEl = document.getElementById("calendar");
    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView:"dayGridMonth",
      locale:"pt-br",
      height:"auto",
      events:eventos,
      eventClick:(info)=>abrirModal(info.event.extendedProps)
    });
    calendar.render();
  }catch(err){
    console.error(err);
    alert("Erro ao carregar reservas. Verifique o endpoint do GAS.");
  }
}

// ðŸªŸ Abrir modal de detalhes
function abrirModal(reserva){
  reservaAtual = reserva;
  const d = document.getElementById("detalhes");
  d.innerHTML = `
    <div class="row"><b>Nome:</b> ${reserva.Nome}</div>
    <div class="row"><b>E-mail:</b> ${reserva["E-mail"]}</div>
    <div class="row"><b>Telefone:</b> ${reserva.Telefone}</div>
    <div class="row"><b>Pessoas:</b> ${reserva.Pessoas}</div>
    <div class="row"><b>Data/Hora:</b> ${reserva["Data/Hora"]}</div>
    <div class="row"><b>ObservaÃ§Ãµes:</b> ${reserva.ObservaÃ§Ãµes || "-"}</div>
    <div class="row"><b>Status:</b> ${reserva.Status}</div>
  `;
  document.getElementById("modal").classList.add("show");
}

// âŒ Fechar modal
document.getElementById("btnFechar").onclick = ()=>{
  document.getElementById("modal").classList.remove("show");
  reservaAtual = null;
};

// âœ… Aceitar reserva â†’ e-mail de confirmaÃ§Ã£o
document.getElementById("btnAceitar").onclick = async ()=>{
  if(!reservaAtual) return;
  await fetch(GAS_ENDPOINT, {
    method:"POST",
    body:new URLSearchParams({
      acao:"atualizarStatus",
      status:"Aceita",
      email:reservaAtual["E-mail"],
      nome:reservaAtual.Nome,
      telefone:reservaAtual.Telefone,
      pessoas:reservaAtual.Pessoas,
      datahora:reservaAtual["Data/Hora"],
      observacoes:reservaAtual.ObservaÃ§Ãµes || ""
    })
  });
  alert("âœ… Reserva aceita e e-mail de confirmaÃ§Ã£o enviado!");
  location.reload();
};

// ðŸŽ‰ Finalizar reserva â†’ e-mail de agradecimento
document.getElementById("btnFinalizar").onclick = async ()=>{
  if(!reservaAtual) return;
  await fetch(GAS_ENDPOINT, {
    method:"POST",
    body:new URLSearchParams({
      acao:"finalizarReserva",
      status:"Finalizada",
      email:reservaAtual["E-mail"],
      nome:reservaAtual.Nome
    })
  });
  alert("ðŸ’š E-mail de agradecimento enviado ao cliente!");
  location.reload();
};

document.addEventListener("DOMContentLoaded", carregarReservas);
</script>
</body>
</html>
