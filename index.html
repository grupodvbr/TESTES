<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Painel de Reservas</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f8f8f8;margin:0;padding:0;color:#333}
    header{background:#2563eb;color:#fff;padding:12px 20px;font-size:1.4rem}
    main{padding:20px}
    table{width:100%;border-collapse:collapse;margin-top:16px}
    th,td{border:1px solid #ccc;padding:8px;text-align:left;font-size:.9rem}
    th{background:#f0f0f0}
    .btn{background:#2563eb;color:#fff;padding:6px 12px;border:none;border-radius:4px;cursor:pointer;font-size:.85rem}
    .btn-danger{background:#dc2626}
    .btn-secondary{background:#6b7280}
    .hidden{display:none}
    #popup{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:1000}
    #popupContent{background:#fff;padding:20px;border-radius:8px;max-width:600px;width:90%;max-height:80%;overflow:auto}
    #formBox{background:#fff;padding:20px;border-radius:8px;margin-bottom:20px}
    label{display:block;margin-top:10px;font-weight:bold}
    input,select,textarea{width:100%;padding:6px;margin-top:4px;border:1px solid #ccc;border-radius:4px}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
  </style>
</head>
<body>
  <header>Painel de Reservas</header>
  <main>
    <div id="formBox">
      <h2 id="formTitle">Nova Reserva</h2>
      <form id="reservaForm">
        <input type="hidden" id="reservaId">
        <label>Nome <input id="nome" required></label>
        <label>Email <input id="email" type="email" required></label>
        <label>Telefone <input id="telefone" required></label>
        <label>Pessoas <input id="pessoas" type="number" required></label>
        <label>Mesa <input id="mesa" required></label>
        <label>Card√°pio <input id="cardapio"></label>
        <label>Data e Hora <input id="datahora" type="datetime-local" required></label>
        <label>Valor Estimado <input id="valorEstimado" type="number" step="0.01"></label>
        <label>Pagamento Antecipado <input id="pagamentoAntecipado" type="number" step="0.01"></label>
        <label>Banco <input id="banco"></label>
        <label>Status 
          <select id="status">
            <option>Pendente</option>
            <option>Confirmada</option>
            <option>Conclu√≠da</option>
            <option>Cancelada</option>
          </select>
        </label>
        <label>Observa√ß√µes <textarea id="observacoes"></textarea></label>
        <label>Anexo <input id="arquivo" type="file"></label>
        <div class="actions" style="margin-top:12px">
          <button type="submit" class="btn">Salvar</button>
          <button type="button" id="cancelEditBtn" class="btn-secondary hidden">Cancelar edi√ß√£o</button>
        </div>
      </form>
    </div>

    <h2>Reservas</h2>
    <table id="tabelaReservas">
      <thead>
        <tr>
          <th>ID</th><th>Nome</th><th>Email</th><th>Telefone</th><th>Pessoas</th>
          <th>Mesa</th><th>Data</th><th>Status</th><th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </main>

  <div id="popup">
    <div id="popupContent">
      <h3>Detalhes da Reserva</h3>
      <div id="popupBody"></div>
      <div style="margin-top:12px">
        <button class="btn-secondary" onclick="fecharPopup()">Fechar</button>
      </div>
    </div>
  </div>

<script>
const API_URL = "YOUR_WEBAPP_URL"; // troque pelo seu WebApp implantado
const form = document.getElementById('reservaForm');
const tabela = document.querySelector('#tabelaReservas tbody');
const popup = document.getElementById('popup');
const popupBody = document.getElementById('popupBody');
const cancelEditBtn = document.getElementById('cancelEditBtn');
let reservas = [];
let editingId = null;

// ===== Required din√¢mico =====
function toggleRequired(isNew){
  const requiredIds = ['nome','email','telefone','pessoas','mesa','datahora'];
  requiredIds.forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    if(isNew){ el.setAttribute('required',''); }
    else{ el.removeAttribute('required'); }
  });
}

// ===== API =====
async function carregarReservas(){
  const hoje = new Date();
  const ano = hoje.getFullYear();
  const mes = hoje.getMonth()+1;
  const res = await fetch(`${API_URL}?acao=listar&ano=${ano}&mes=${mes}`);
  reservas = await res.json();
  renderTabela();
}

function renderTabela(){
  tabela.innerHTML="";
  reservas.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.ID}</td>
      <td>${r.Nome}</td>
      <td>${r.Email}</td>
      <td>${r.Telefone}</td>
      <td>${r.Pessoas}</td>
      <td>${r.Mesa}</td>
      <td>${r.DataHora}</td>
      <td>${r.Status}</td>
      <td class="actions">
        <button class="btn" onclick="verReserva('${r.ID}')">Ver</button>
        <button class="btn" onclick="editarReserva('${r.ID}')">Editar</button>
        <button class="btn-danger" onclick="excluirReserva('${r.ID}')">Excluir</button>
      </td>
    `;
    tabela.appendChild(tr);
  });
}

// ===== Ver popup =====
function verReserva(id){
  const r = reservas.find(x=>String(x.ID)===String(id));
  if(!r) return;
  let html = `
    <p><b>Nome:</b> ${r.Nome}</p>
    <p><b>Email:</b> ${r.Email}</p>
    <p><b>Telefone:</b> ${r.Telefone}</p>
    <p><b>Pessoas:</b> ${r.Pessoas}</p>
    <p><b>Mesa:</b> ${r.Mesa}</p>
    <p><b>Data:</b> ${r.DataHora}</p>
    <p><b>Status:</b> ${r.Status}</p>
    <p><b>Observa√ß√µes:</b> ${r.Observacoes||""}</p>
  `;

  // Anexos
  const anexos = Object.keys(r).filter(k=>k.toLowerCase().includes('anexo'));
  if(anexos.length){
    html += "<p><b>Anexos:</b><br>";
    anexos.forEach((a,i)=>{
      if(r[a]) html += `<a href="${r[a]}" target="_blank">üìé Anexo ${i+1}</a><br>`;
    });
    html += "</p>";
  }

  // Pagamentos
  const pagamentos = Object.keys(r).filter(k=>k.toLowerCase().includes('pagamento'));
  if(pagamentos.length){
    html += "<p><b>Pagamentos:</b><br>";
    pagamentos.forEach((p,i)=>{
      if(r[p]) html += `Pagamento ${i+1}: R$ ${r[p]}<br>`;
    });
    html += "</p>";
  }

  popupBody.innerHTML=html;
  popup.style.display='flex';
}
function fecharPopup(){ popup.style.display='none'; }

// ===== Editar =====
function editarReserva(id){
  const r = reservas.find(x=>String(x.ID)===String(id));
  if(!r) return;
  editingId=id;
  toggleRequired(false);
  document.getElementById('formTitle').innerText="Editar Reserva";
  document.getElementById('reservaId').value=id;
  document.getElementById('nome').value=r.Nome||"";
  document.getElementById('email').value=r.Email||"";
  document.getElementById('telefone').value=r.Telefone||"";
  document.getElementById('pessoas').value=r.Pessoas||"";
  document.getElementById('mesa').value=r.Mesa||"";
  document.getElementById('cardapio').value=r.Cardapio||"";
  document.getElementById('datahora').value=r.DataHora? r.DataHora.replace(" ","T"):"";
  document.getElementById('valorEstimado').value=r.ValorEstimado||"";
  document.getElementById('pagamentoAntecipado').value=r.PagamentoAntecipado||"";
  document.getElementById('banco').value=r.Banco||"";
  document.getElementById('status').value=r.Status||"Pendente";
  document.getElementById('observacoes').value=r.Observacoes||"";
  cancelEditBtn.classList.remove('hidden');
}

// ===== Excluir =====
async function excluirReserva(id){
  if(!confirm("Deseja excluir esta reserva?")) return;
  await fetch(API_URL, {
    method:"POST",
    body:new URLSearchParams({acao:"excluir",id})
  });
  await carregarReservas();
}

// ===== Salvar =====
form.addEventListener('submit', async e=>{
  e.preventDefault();
  const fd = new FormData(form);
  const params = new URLSearchParams();
  if(editingId){ params.append("acao","atualizar"); params.append("id",editingId);}
  else{ params.append("acao","cadastrar"); }
  for(const [k,v] of fd.entries()){ if(k==="arquivo" && v instanceof File && v.size){
      const b64 = await toBase64(v); params.append("arquivo",b64); params.append("nomeArquivo",v.name);
    } else { params.append(k,v);}
  }
  await fetch(API_URL,{method:"POST",body:params});
  form.reset(); editingId=null;
  document.getElementById('formTitle').innerText="Nova Reserva";
  cancelEditBtn.classList.add('hidden');
  toggleRequired(true);
  await carregarReservas();
});

cancelEditBtn.addEventListener('click',()=>{
  form.reset();
  editingId=null;
  cancelEditBtn.classList.add('hidden');
  document.getElementById('formTitle').innerText="Nova Reserva";
  toggleRequired(true);
});

function toBase64(file){
  return new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.onload=()=>resolve(reader.result.split(',')[1]);
    reader.onerror=reject;
    reader.readAsDataURL(file);
  });
}

carregarReservas();
</script>
</body>
</html>
